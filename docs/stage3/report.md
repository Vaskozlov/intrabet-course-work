# Отчет по третьей стадии выполнения проекта

## 1. Диаграмма классов, представляющая общую архитектуру системы

Диаграмма классов разработана для представления общей архитектуры системы букмекерской конторы, специализирующейся на университетских событиях. Она включает ключевые компоненты: сущности базы данных (User, Event, Category, Outcome, Bet, Wallet и др.), сервисы (EventsService, BetService, CategoryService, AuthenticationService и т.д.), контроллеры (AuthenticationController, CategoryController, BetsController, EventsController и др.), а также вспомогательные классы для валидации (OutcomeValidator, CategoryValidator) и безопасности (SecurityConfig, TokenAuthenticationFilter). 

Диаграмма отображает зависимости между классами, включая аннотации Spring (например, @Entity, @Service, @RestController), отношения (OneToMany, ManyToOne) и интерфейсы (например, TokenService). Подробная диаграмма классов приведена в предоставленном изображении (третье изображение). Дополнительно, для иллюстрации общей архитектуры системы использованы две диаграммы: первая отражает высокоуровневую структуру (frontend, backend, API, база данных), вторая — систему ставок (с фокусом на процесс обработки ставок и уведомлений). Эти изображения демонстрируют интеграцию уровней и поток данных без детального кода.

## 2. Реализация уровня хранения информационной системы

Уровень хранения реализован на основе базы данных, разработанной на втором этапе (PostgreSQL с таблицами Users, Events, Bets, Outcomes, Categories, Wallets и др.). Для взаимодействия с БД использован Spring Data JPA с репозиториями (EventRepository, OutcomeRepository, BetRepository, CategoryRepository, WalletRepository, UserRepository), которые наследуют от JpaRepository и предоставляют базовые CRUD-операции, а также кастомные запросы (например, findByCategory, findByStatusNotInAndEndsAtGreaterThan в EventRepository).

Добавлены индексы для оптимизации производительности, как указано в файле indexes.sql (например, idx_users_email, idx_event_status, idx_outcome_event_id). Это соответствует рекомендациям из Stage2.md, где описаны индексы для ускорения запросов в read-heavy сценариях (просмотр событий, ставок, транзакций).

## 3. Использование функций/процедур pl/pgsql

При реализации уровня хранения строго использованы функции и процедуры, созданные на втором этапе с помощью pl/pgsql, без их замещения альтернативными запросами на уровне Java. В частности:

- Триггер для автоматического создания кошелька при регистрации пользователя (create_wallet() в wallet_trigger.sql) интегрирован в процесс регистрации (в AuthenticationService при вызове userRepository.save(user)).
- Индексы и оптимизированные запросы из Stage2.md применены напрямую в репозиториях (например, через @Index в сущностях Event и Outcome).
- Бизнес-логика не дублирует SQL-запросы; вместо этого репозитории полагаются на JPA и существующие pl/pgsql-конструкции для операций вроде создания событий и ставок.

Это обеспечивает консистенцию и избегает дублирования кода, как предписано заданием.

## 4. Реализация уровня бизнес-логики информационной системы

Уровень бизнес-логики реализован на основе описания бизнес-процессов из первого этапа (Stage1.md: регистрация/аутентификация, просмотр/создание событий, размещение/расчет ставок, уведомления, управление категориями) и уровня хранения. Ключевые компоненты:

- **Сервисы**: EventsService обрабатывает создание, поиск и завершение событий (с расчетом выигрышей и уведомлениями через EventNotificationService и UserNotificationService); BetService — размещение ставок с проверкой баланса и обновлением кошелька; CategoryService — создание категорий; AuthenticationService — регистрация/логин с валидацией (NewUserValidator) и хэшированием паролей (Argon2PasswordEncoder).
- **Безопасность и аутентификация**: JWT-токены (JwtTokenService), фильтр (TokenAuthenticationFilter) и конфигурация (SecurityConfig) для защиты эндпоинтов (permitAll для /auth и /events/list, роль ADMIN для /admin).
- **Уведомления**: SSE (Server-Sent Events) для реального времени (EventNotificationService для обновлений событий, UserNotificationService для изменений аккаунта).
- **Валидация**: Кастомные аннотации (@ValidOutcomeId, @ValidCategory) с валидаторами для проверки исходов и категорий.
- **DTO и маппинг**: Использованы DTO (UserRegistrationDTO, BetDTO, CreatedEventDTO и др.) для передачи данных между слоями.
- **Кэширование**: @Cacheable для категорий (в Category) с Ehcache.
- **API**: Описано в API.yaml (OpenAPI 3.0) с эндпоинтами для аутентификации, событий, ставок и уведомлений.

Бизнес-логика интегрирована с хранением через репозитории, обеспечивая транзакционность (@Transactional в сервисах). Зависимости проекта управляются через build.gradle.kts (Spring Boot 3.3.5, PostgreSQL driver, MapStruct и др.).

## Заключение

На третьем этапе реализована полная backend-архитектура системы, интегрирующая хранение и бизнес-логику. Все компоненты соответствуют предыдущим этапам, с фокусом на безопасность, производительность и реальном времени. Код готов к интеграции с frontend. Общий объем реализации: ~20 сущностей/сервисов, ~10 контроллеров/валидаторов.